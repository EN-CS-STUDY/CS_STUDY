### 작성자 : 홍영환

# 유저모드, 커널모드, 시스템콜


운영체제를 통해 안정적이고, 효율적인 동작을 하기 위해서는 사용자 또는 응용프로그램이 직접 하드웨어에 접근하는 것을 막아야 한다.

## 📚 운영체제의 컴퓨터 제어 방법

### 💡이중 동작 모드( Dual-mode Operation )

CPU를 어떻게 사용하느냐에 따라 2가지 방식으로 제어한다

### 유저모드 (User Mode)

- 사용자와 데이터를 와다갔다 할 수 있는 등의 작업을 한다.

### 커널모드 (Kernel Mode)

- 운영체제 내부에서 실제로 하드웨어를 제어할 수 있다.

이 둘은 요청에 따라서 모드가 서로 왔다갔다 한다.

이 요청은 **시스템 콜 (System Call)**을 통해서 전환이 된다.

평소에는 유저모드로 대기하고 있다. 만약 사용자가 입력을 하면 **유저모드**에서 **시스템 콜**이 발생한다. 시스템 콜에 의해 **커널모드**로 변하게 되고 내부에 들어온 요청을 가지고 작업을 수행 후 다시 **유저모드**로 대기를 한다.

### mode bit

---

커널 모드와 사용자 모드를 구분하기 위해 참고되는 1(사용자 모드) 또는 0(커널 모드)의 값을 가지는 플래그 변수이다.

카메라, 키보드 등 I/O 디바이스를 운영체제를 통해서만 사용할 수 있게 하여 외부로부터 사용자 장비를 보호한다.

![Untitled](https://github.com/EN-CS-STUDY/CS_STUDY/assets/77156858/93f90c59-df06-4307-adb7-d81dceb7440c)

카카오톡 같은 프로그램을 사용할 때, 여러가지 명령을 수행을 하게 된다. 

1. Job1(카카오톡) 프로그램이 실행되면서 명령을 요청했다(2번상태).
2. 2번상태로 내려가면, 시스템 콜을 부른다. 그러면 밑에 커널모드에서 컴퓨터가 exception handler를 통해 수행을 한다. 
3. 이 후 4번 모드로 돌아온다.그러면서 Job1(카카오톡)이 waiting 상태가 되고, Job2(다른 프로그램)가 running 상태가 된다. 
4. 예를들어, Job1인 카카오톡이 실행중이었는데, Job2라는 크롬 프로그램이 뭔가를 하려고 기다리고 있었다고 가정해보자.
5. (1번상태) 카카오톡이 작업을 수행하고 있는데, 크롬이 본인도 작업을 해야한다고 하면서 시스템콜 요청을 보낸다. 그게 getc라고 하는 시스템 콜이다.
6.  시스템 콜이 운영체제로 가면, Job2가 뭔갈 하고 싶데 카카오톡 너 잠깐만 있어봐 크롬이랑 뭐좀 하고 올게 하고, 3번으로 내려가서 그 작업을 수행한다음 크롬이 일할 수 있는 환경을 만들어준다.

### 📕 일을 할 수 있는 환경을 만들어 주는 것은 무슨 뜻?

컴퓨터의 메인 메모리 안에 코드 + 데이터가 올라와있다. 그걸 접근할 수 있는건 CPU밖에 없다.

CPU가 일을 하려면 어떤 코드와 어떤 데이터를 메인 메모리에서 가져와서 쓰는지 매번 결정해야 한다 → 이를 운영체제가 커널모드에서 관리

**즉, 유저모드에서 수행하고자 하는 어플리케이션 요청 → 커널모드에서 CPU한테 작업을 수행하도록 명령 → CPU는 하던 일을 멈추고 요청한 일을 수행.**

### 📕 도중에 키보드 입력이 들어오면?

**→ 키보드 인터럽트라는 시스템 콜 호출**

키보드 인터럽트가 들어오면 유저모드에서 키보드를 담당하는 프로그램이 운영체제에게 모든 일을 멈추고 키보드에 대한 일을 먼저 수행하도록 명령한다.

### 📕어떻게 프로그램을 실행하며 사용자의 입출력도 처리할까?

→ **CPU가 굉장히 빠르게 처리하기 때문에 가능하다**

요즘 CPU는 다중 코어로 이루어져 있는데, 다른 코어에게 시스템 콜을 서로 처리할 수 있다. 즉 병렬처리가 가능하다. (**프로세스 스케쥴링, 멀티스레딩 프로세싱)**

## 📚 시스템콜 (System Call)

<aside>
💡 운영체제가 컴퓨터 하드웨어를 다루기 위해 입출력, 메모리할당, 프로세스의 생성 등을 수행하는 코드의 집합이다.

</aside>

**시스템 콜의 유형에는 총 5가지가 있다.**

1. Process Control: 작업, 일이라고 생각하면 된다. 프로세스라는게 컴퓨터가 일을 하는 단위. 어떤 걸 시작하고, 어떤 걸 멈추고 할지를 정해주는 것.
2. File Management: 한컴을 통해 문서작업을 하면, 다운로드 받는거, 저장하는거, 삭제하는 것 등.
3. Device Management: 컴퓨터에 달려있는 디바이스들.(연결되어있는 모든 I/O 디바이스)이걸 운영체제에서 시스템 콜 형태로 관리함.
4. Information Maintenance: 지금 컴퓨터가 사용하고 있는 여러가지 정보들. 지금 현재 컴퓨터에서 작동하고 있는 모든 정보. 컴퓨터 시간 등. 컴퓨터가 나타내는 상태들을 관리할 수 있음.
5. Communications (between computer and computer): 주로, 네트워크 생각하면됨. 컴퓨터가 다른 컴퓨터랑 소통하는 것.(네트워크란 결국 다른 컴퓨터랑 소통하는 것) 컴퓨터끼리 소통할때 커뮤니케이션을 함. 시스템콜이 역시 이것을 관리함. 블루투스, 와이파이 등도 커뮤니케이션. 공유기도 다른 개념의 컴퓨터임. 맥OS로 아이폰에 에어드랍을 하면 이것도 커뮤니케이션.

ex) 보호 → chmode( ), unmask( ), chown( )

**시스템 콜 예시**

```
cp in.txt out.txt
```

일반적으로 윈도우 운영체제의 경우 마우스, 리눅스라면 키보드가 사용자의 입력을 받는다. 이 때 I/O 시스템 콜을 사용한다.

위와 같은 문장을 입력 받아서 `cp` 프로그램을 실행시키면 먼저 `in.txt` 파일이 현재 디렉터리에서 접근할 수 있는 파일인지를 검사하기 위해 시스템 콜을 호출한다.

만약 파일이 존재하지 않는다면 에러를 발생시켜야 하고 프로그램을 종료하는데 이 때 시스템 콜이 사용된다.

만약 파일이 존재할 경우, 복사한 파일을 저장하기 위해 `output.txt` 파일명이 있는지 검사한다.

그리고 이 때도 마찬가지로 파일명이 존재하는지 존재하지 않는지 검사하기 위해 시스템 콜을 통해 확인한다.

파일이 이미 존재한다면 덮어 씌워야 할지 아니면 이어 붙여야 하는지 사용자에게 물어볼 수 있다.

만약 저장하고자 하는 파일 이름이 겹치지 않는다면, 파일을 저장해야하는데 이 때도 시스템 콜을 이용한다.

📚 **참고문헌**

[https://coduking.tistory.com/entry/운영체제-유저모드-커널모드-시스템콜](https://coduking.tistory.com/entry/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%EC%9C%A0%EC%A0%80%EB%AA%A8%EB%93%9C-%EC%BB%A4%EB%84%90%EB%AA%A8%EB%93%9C-%EC%8B%9C%EC%8A%A4%ED%85%9C%EC%BD%9C)